<?php
/**
 * ============================================================================
 * MODULE : Articles Gaming ‚Äî M√©tadonn√©es & Fiche Jeu
 * ============================================================================
 *
 * Enrichit les articles WordPress (posts) avec des champs m√©tier
 * adapt√©s √† une communaut√© gaming :
 *
 * üìã FICHE JEU :
 *   - Nom du jeu, plateformes, nombre de joueurs
 *   - Temps de jeu moyen, d√©veloppeur, √©diteur
 *
 * ‚≠ê NOTES & √âVALUATIONS :
 *   - Note globale (1-5 √©toiles)
 *   - Notes par crit√®re : Gameplay, Direction artistique,
 *     Bande-son, Sc√©nario, Accessibilit√©, Ambiance cozy
 *
 * üìù VERDICT :
 *   - Type d'article (Test, Guide, Coup de c≈ìur, Actualit√©, Dossier)
 *   - Verdict r√©sum√©
 *   - Points forts / Points faibles
 *
 * Les donn√©es sont affich√©es automatiquement en haut des articles
 * sous forme de fiche jeu illustr√©e, puis en bas pour le verdict.
 *
 * @package CozyGaming
 * @since 1.7.0
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}


/**
 * -----------------------------------------------
 * 1. CONSTANTES & CONFIGURATION
 * -----------------------------------------------
 */

/**
 * Retourne la liste des plateformes support√©es
 *
 * @return array slug => label
 */
function cozy_get_platforms() {
    return apply_filters( 'cozy_article_platforms', array(
        'pc'          => 'üñ•Ô∏è PC',
        'ps5'         => 'üéÆ PS5',
        'ps4'         => 'üéÆ PS4',
        'xbox_series' => 'üü¢ Xbox Series',
        'xbox_one'    => 'üü¢ Xbox One',
        'switch'      => 'üî¥ Nintendo Switch',
        'switch_2'    => 'üî¥ Nintendo Switch 2',
        'mobile'      => 'üì± Mobile',
        'vr'          => 'ü•Ω VR',
        'mac'         => 'üçé Mac',
        'linux'       => 'üêß Linux',
        'retro'       => 'üïπÔ∏è R√©tro',
    ) );
}

/**
 * Retourne les crit√®res de notation
 *
 * @return array slug => array( label, icon, description )
 */
function cozy_get_rating_criteria() {
    return apply_filters( 'cozy_rating_criteria', array(
        'gameplay'     => array(
            'label' => 'Gameplay',
            'icon'  => 'üéÆ',
            'desc'  => 'Qualit√© des m√©caniques de jeu',
        ),
        'direction_art' => array(
            'label' => 'Direction artistique',
            'icon'  => 'üé®',
            'desc'  => 'Graphismes, style visuel',
        ),
        'bande_son'    => array(
            'label' => 'Bande-son',
            'icon'  => 'üéµ',
            'desc'  => 'Musique et effets sonores',
        ),
        'scenario'     => array(
            'label' => 'Sc√©nario',
            'icon'  => 'üìú',
            'desc'  => 'Histoire et narration',
        ),
        'accessibilite' => array(
            'label' => 'Accessibilit√©',
            'icon'  => '‚ôø',
            'desc'  => 'Options d\'accessibilit√©, prise en main',
        ),
        'ambiance_cozy' => array(
            'label' => 'Ambiance cozy',
            'icon'  => '‚òï',
            'desc'  => 'Le jeu est-il relaxant et agr√©able ?',
        ),
    ) );
}


/**
 * -----------------------------------------------
 * 2. TAXONOMIE TYPE D'ARTICLE
 * -----------------------------------------------
 */

/**
 * Ins√®re les types d'article par d√©faut
 */
function cozy_insert_default_article_types() {
    $types = cozy_get_article_types();

    foreach ( $types as $slug => $data ) {
        if ( ! term_exists( $slug, 'cozy_article_type' ) ) {
            wp_insert_term( $data['icon'] . ' ' . $data['label'], 'cozy_article_type', array(
                'slug' => $slug,
            ) );
        }
    }
}
add_action( 'admin_init', function() {
    if ( get_option( 'cozy_article_types_initialized' ) ) {
        return;
    }
    cozy_insert_default_article_types();
    update_option( 'cozy_article_types_initialized', true );
} );


/**
 * -----------------------------------------------
 * 3. META BOXES DANS L'√âDITEUR CLASSIQUE & GUTENBERG
 * -----------------------------------------------
 */

/**
 * Enregistre les meta keys pour l'API REST (Gutenberg)
 */
function cozy_register_article_meta() {
    $meta_keys = array(
        // Fiche jeu
        '_cozy_game_name'       => 'string',
        '_cozy_game_platforms'  => 'string',   // JSON array
        '_cozy_game_players'    => 'string',
        '_cozy_game_playtime'   => 'string',
        '_cozy_game_developer'  => 'string',
        '_cozy_game_publisher'  => 'string',
        // Notes
        '_cozy_rating_global'   => 'number',
        '_cozy_ratings'         => 'string',   // JSON object
        // Verdict
        '_cozy_verdict'         => 'string',
        '_cozy_pros'            => 'string',   // JSON array
        '_cozy_cons'            => 'string',   // JSON array
    );

    foreach ( $meta_keys as $key => $type ) {
        register_post_meta( 'post', $key, array(
            'show_in_rest'  => true,
            'single'        => true,
            'type'          => $type,
            'auth_callback' => function() {
                return current_user_can( 'edit_posts' );
            },
        ) );
    }
}
add_action( 'init', 'cozy_register_article_meta' );


/**
 * Ajoute les meta boxes dans l'√©diteur classique
 */
function cozy_add_article_meta_boxes() {
    add_meta_box(
        'cozy_game_info',
        'üéÆ Fiche du jeu',
        'cozy_render_game_info_meta_box',
        'post',
        'normal',
        'high'
    );

    add_meta_box(
        'cozy_game_ratings',
        '‚≠ê Notes & √©valuations',
        'cozy_render_ratings_meta_box',
        'post',
        'normal',
        'high'
    );

    add_meta_box(
        'cozy_game_verdict',
        'üìù Verdict',
        'cozy_render_verdict_meta_box',
        'post',
        'normal',
        'high'
    );
}
add_action( 'add_meta_boxes', 'cozy_add_article_meta_boxes' );


/**
 * -----------------------------------------------
 * 3a. META BOX ‚Äî FICHE DU JEU
 * -----------------------------------------------
 */
function cozy_render_game_info_meta_box( $post ) {
    wp_nonce_field( 'cozy_save_article_meta', 'cozy_article_meta_nonce' );

    $game_name   = get_post_meta( $post->ID, '_cozy_game_name', true );
    $platforms   = json_decode( get_post_meta( $post->ID, '_cozy_game_platforms', true ) ?: '[]', true );
    $players     = get_post_meta( $post->ID, '_cozy_game_players', true );
    $playtime    = get_post_meta( $post->ID, '_cozy_game_playtime', true );
    $developer   = get_post_meta( $post->ID, '_cozy_game_developer', true );
    $publisher   = get_post_meta( $post->ID, '_cozy_game_publisher', true );
    $all_platforms = cozy_get_platforms();

    ?>
    <div class="cozy-meta-box">
        <p class="cozy-meta-box__hint">
            üí° Remplis uniquement les champs pertinents pour ton article. Tu peux tout laisser vide si ce n'est pas un article li√© √† un jeu.
        </p>

        <table class="form-table cozy-meta-box__table">
            <tr>
                <th><label for="cozy_game_name">üéÆ Nom du jeu</label></th>
                <td>
                    <input
                        type="text"
                        id="cozy_game_name"
                        name="cozy_game_name"
                        value="<?php echo esc_attr( $game_name ); ?>"
                        class="regular-text"
                        placeholder="Ex : Animal Crossing: New Horizons"
                    >
                </td>
            </tr>
            <tr>
                <th>üïπÔ∏è Plateformes</th>
                <td class="cozy-meta-box__platforms">
                    <?php foreach ( $all_platforms as $slug => $label ) : ?>
                        <label class="cozy-meta-box__platform-label">
                            <input
                                type="checkbox"
                                name="cozy_game_platforms[]"
                                value="<?php echo esc_attr( $slug ); ?>"
                                <?php checked( in_array( $slug, $platforms, true ) ); ?>
                            >
                            <?php echo esc_html( $label ); ?>
                        </label>
                    <?php endforeach; ?>
                </td>
            </tr>
            <tr>
                <th><label for="cozy_game_players">üë• Nombre de joueurs</label></th>
                <td>
                    <input
                        type="text"
                        id="cozy_game_players"
                        name="cozy_game_players"
                        value="<?php echo esc_attr( $players ); ?>"
                        class="regular-text"
                        placeholder="Ex : 1-4 joueurs, 1-8 en ligne"
                    >
                </td>
            </tr>
            <tr>
                <th><label for="cozy_game_playtime">‚è±Ô∏è Temps de jeu</label></th>
                <td>
                    <input
                        type="text"
                        id="cozy_game_playtime"
                        name="cozy_game_playtime"
                        value="<?php echo esc_attr( $playtime ); ?>"
                        class="regular-text"
                        placeholder="Ex : ~30h (histoire), 100h+ (compl√©tion)"
                    >
                </td>
            </tr>
            <tr>
                <th><label for="cozy_game_developer">üõ†Ô∏è D√©veloppeur</label></th>
                <td>
                    <input
                        type="text"
                        id="cozy_game_developer"
                        name="cozy_game_developer"
                        value="<?php echo esc_attr( $developer ); ?>"
                        class="regular-text"
                        placeholder="Ex : Nintendo EPD"
                    >
                </td>
            </tr>
            <tr>
                <th><label for="cozy_game_publisher">üì¶ √âditeur</label></th>
                <td>
                    <input
                        type="text"
                        id="cozy_game_publisher"
                        name="cozy_game_publisher"
                        value="<?php echo esc_attr( $publisher ); ?>"
                        class="regular-text"
                        placeholder="Ex : Nintendo"
                    >
                </td>
            </tr>
        </table>
    </div>
    <?php
}


/**
 * -----------------------------------------------
 * 3b. META BOX ‚Äî NOTES & √âVALUATIONS
 * -----------------------------------------------
 */
function cozy_render_ratings_meta_box( $post ) {
    $global_rating = get_post_meta( $post->ID, '_cozy_rating_global', true );
    $ratings_json  = get_post_meta( $post->ID, '_cozy_ratings', true );
    $ratings       = json_decode( $ratings_json ?: '{}', true );
    $criteria      = cozy_get_rating_criteria();

    ?>
    <div class="cozy-meta-box">
        <table class="form-table cozy-meta-box__table">
            <tr>
                <th>
                    <label for="cozy_rating_global">üåü Note globale</label>
                    <p class="description">Note de 1 √† 5 (laisse vide si pas de note)</p>
                </th>
                <td>
                    <div class="cozy-meta-box__stars" id="cozy-global-stars">
                        <?php for ( $i = 1; $i <= 5; $i++ ) : ?>
                            <label class="cozy-meta-box__star-label">
                                <input
                                    type="radio"
                                    name="cozy_rating_global"
                                    value="<?php echo $i; ?>"
                                    <?php checked( (int) $global_rating, $i ); ?>
                                >
                                <span class="cozy-meta-box__star <?php echo ( (int) $global_rating >= $i ) ? 'active' : ''; ?>">‚òÖ</span>
                            </label>
                        <?php endfor; ?>
                        <button type="button" class="button button-small cozy-meta-box__clear-rating" data-target="cozy_rating_global">
                            Effacer
                        </button>
                    </div>
                </td>
            </tr>
        </table>

        <h4 style="margin: 20px 0 10px;">üìä Notes d√©taill√©es par crit√®re</h4>
        <p class="description" style="margin-bottom: 15px;">Note chaque crit√®re de 1 √† 5 √©toiles. Laisse vide les crit√®res non pertinents.</p>

        <table class="form-table cozy-meta-box__table">
            <?php foreach ( $criteria as $slug => $criterion ) : 
                $value = isset( $ratings[ $slug ] ) ? (int) $ratings[ $slug ] : 0;
            ?>
                <tr>
                    <th>
                        <label><?php echo $criterion['icon'] . ' ' . esc_html( $criterion['label'] ); ?></label>
                        <p class="description"><?php echo esc_html( $criterion['desc'] ); ?></p>
                    </th>
                    <td>
                        <div class="cozy-meta-box__stars">
                            <?php for ( $i = 1; $i <= 5; $i++ ) : ?>
                                <label class="cozy-meta-box__star-label">
                                    <input
                                        type="radio"
                                        name="cozy_ratings[<?php echo esc_attr( $slug ); ?>]"
                                        value="<?php echo $i; ?>"
                                        <?php checked( $value, $i ); ?>
                                    >
                                    <span class="cozy-meta-box__star <?php echo ( $value >= $i ) ? 'active' : ''; ?>">‚òÖ</span>
                                </label>
                            <?php endfor; ?>
                            <button type="button" class="button button-small cozy-meta-box__clear-rating" data-target="cozy_ratings[<?php echo esc_attr( $slug ); ?>]">
                                Effacer
                            </button>
                        </div>
                    </td>
                </tr>
            <?php endforeach; ?>
        </table>
    </div>
    <?php
}


/**
 * -----------------------------------------------
 * 3c. META BOX ‚Äî VERDICT
 * -----------------------------------------------
 */
function cozy_render_verdict_meta_box( $post ) {
    $verdict   = get_post_meta( $post->ID, '_cozy_verdict', true );
    $pros_json = get_post_meta( $post->ID, '_cozy_pros', true );
    $cons_json = get_post_meta( $post->ID, '_cozy_cons', true );
    $pros      = json_decode( $pros_json ?: '[]', true );
    $cons      = json_decode( $cons_json ?: '[]', true );

    // S'assurer qu'il y a au moins 3 lignes vides
    while ( count( $pros ) < 3 ) { $pros[] = ''; }
    while ( count( $cons ) < 3 ) { $cons[] = ''; }

    ?>
    <div class="cozy-meta-box">
        <table class="form-table cozy-meta-box__table">
            <tr>
                <th><label for="cozy_verdict">üí¨ Verdict / R√©sum√©</label></th>
                <td>
                    <textarea
                        id="cozy_verdict"
                        name="cozy_verdict"
                        rows="3"
                        class="large-text"
                        placeholder="Un jeu cozy parfait pour les soir√©es d'hiver, avec un charme ind√©niable malgr√© quelques longueurs."
                    ><?php echo esc_textarea( $verdict ); ?></textarea>
                </td>
            </tr>
        </table>

        <div class="cozy-meta-box__pros-cons">
            <div class="cozy-meta-box__column cozy-meta-box__column--pros">
                <h4>‚úÖ Points forts</h4>
                <div id="cozy-pros-list">
                    <?php foreach ( $pros as $i => $pro ) : ?>
                        <div class="cozy-meta-box__list-item">
                            <input
                                type="text"
                                name="cozy_pros[]"
                                value="<?php echo esc_attr( $pro ); ?>"
                                class="regular-text"
                                placeholder="Ex : Direction artistique sublime"
                            >
                            <button type="button" class="button cozy-meta-box__remove-item" title="Supprimer">‚úï</button>
                        </div>
                    <?php endforeach; ?>
                </div>
                <button type="button" class="button cozy-meta-box__add-item" data-list="cozy-pros-list" data-name="cozy_pros[]">
                    + Ajouter un point fort
                </button>
            </div>

            <div class="cozy-meta-box__column cozy-meta-box__column--cons">
                <h4>‚ùå Points faibles</h4>
                <div id="cozy-cons-list">
                    <?php foreach ( $cons as $i => $con ) : ?>
                        <div class="cozy-meta-box__list-item">
                            <input
                                type="text"
                                name="cozy_cons[]"
                                value="<?php echo esc_attr( $con ); ?>"
                                class="regular-text"
                                placeholder="Ex : Quelques bugs mineurs"
                            >
                            <button type="button" class="button cozy-meta-box__remove-item" title="Supprimer">‚úï</button>
                        </div>
                    <?php endforeach; ?>
                </div>
                <button type="button" class="button cozy-meta-box__add-item" data-list="cozy-cons-list" data-name="cozy_cons[]">
                    + Ajouter un point faible
                </button>
            </div>
        </div>
    </div>
    <?php
}


/**
 * -----------------------------------------------
 * 4. SAUVEGARDE DES M√âTAS
 * -----------------------------------------------
 */
function cozy_save_article_meta( $post_id ) {
    // V√©rifications de s√©curit√©
    if ( ! isset( $_POST['cozy_article_meta_nonce'] ) ) {
        return;
    }

    if ( ! wp_verify_nonce( $_POST['cozy_article_meta_nonce'], 'cozy_save_article_meta' ) ) {
        return;
    }

    if ( defined( 'DOING_AUTOSAVE' ) && DOING_AUTOSAVE ) {
        return;
    }

    if ( ! current_user_can( 'edit_post', $post_id ) ) {
        return;
    }

    // --- Fiche jeu ---
    $text_fields = array(
        'cozy_game_name'      => '_cozy_game_name',
        'cozy_game_players'   => '_cozy_game_players',
        'cozy_game_playtime'  => '_cozy_game_playtime',
        'cozy_game_developer' => '_cozy_game_developer',
        'cozy_game_publisher' => '_cozy_game_publisher',
    );

    foreach ( $text_fields as $form_key => $meta_key ) {
        if ( isset( $_POST[ $form_key ] ) ) {
            $value = sanitize_text_field( $_POST[ $form_key ] );
            if ( ! empty( $value ) ) {
                update_post_meta( $post_id, $meta_key, $value );
            } else {
                delete_post_meta( $post_id, $meta_key );
            }
        }
    }

    // Plateformes (array ‚Üí JSON)
    if ( isset( $_POST['cozy_game_platforms'] ) && is_array( $_POST['cozy_game_platforms'] ) ) {
        $platforms = array_map( 'sanitize_text_field', $_POST['cozy_game_platforms'] );
        update_post_meta( $post_id, '_cozy_game_platforms', wp_json_encode( $platforms ) );
    } else {
        delete_post_meta( $post_id, '_cozy_game_platforms' );
    }

    // --- Notes ---
    if ( isset( $_POST['cozy_rating_global'] ) && $_POST['cozy_rating_global'] !== '' ) {
        $global = absint( $_POST['cozy_rating_global'] );
        if ( $global >= 1 && $global <= 5 ) {
            update_post_meta( $post_id, '_cozy_rating_global', $global );
        }
    } else {
        delete_post_meta( $post_id, '_cozy_rating_global' );
    }

    // Notes d√©taill√©es
    if ( isset( $_POST['cozy_ratings'] ) && is_array( $_POST['cozy_ratings'] ) ) {
        $ratings = array();
        foreach ( $_POST['cozy_ratings'] as $criterion => $value ) {
            $value = absint( $value );
            if ( $value >= 1 && $value <= 5 ) {
                $ratings[ sanitize_key( $criterion ) ] = $value;
            }
        }
        if ( ! empty( $ratings ) ) {
            update_post_meta( $post_id, '_cozy_ratings', wp_json_encode( $ratings ) );
        } else {
            delete_post_meta( $post_id, '_cozy_ratings' );
        }
    } else {
        delete_post_meta( $post_id, '_cozy_ratings' );
    }

    // --- Verdict ---
    if ( isset( $_POST['cozy_verdict'] ) ) {
        $verdict = sanitize_textarea_field( $_POST['cozy_verdict'] );
        if ( ! empty( $verdict ) ) {
            update_post_meta( $post_id, '_cozy_verdict', $verdict );
        } else {
            delete_post_meta( $post_id, '_cozy_verdict' );
        }
    }

    // Points forts
    if ( isset( $_POST['cozy_pros'] ) && is_array( $_POST['cozy_pros'] ) ) {
        $pros = array_values( array_filter( array_map( 'sanitize_text_field', $_POST['cozy_pros'] ) ) );
        if ( ! empty( $pros ) ) {
            update_post_meta( $post_id, '_cozy_pros', wp_json_encode( $pros ) );
        } else {
            delete_post_meta( $post_id, '_cozy_pros' );
        }
    }

    // Points faibles
    if ( isset( $_POST['cozy_cons'] ) && is_array( $_POST['cozy_cons'] ) ) {
        $cons = array_values( array_filter( array_map( 'sanitize_text_field', $_POST['cozy_cons'] ) ) );
        if ( ! empty( $cons ) ) {
            update_post_meta( $post_id, '_cozy_cons', wp_json_encode( $cons ) );
        } else {
            delete_post_meta( $post_id, '_cozy_cons' );
        }
    }
}
add_action( 'save_post_post', 'cozy_save_article_meta' );


/**
 * -----------------------------------------------
 * 5. AFFICHAGE FRONT-END ‚Äî FICHE JEU (en haut)
 * -----------------------------------------------
 */

/**
 * V√©rifie si un article a des donn√©es gaming remplies
 *
 * @param int $post_id
 * @return bool
 */
function cozy_article_has_game_data( $post_id ) {
    $checks = array(
        '_cozy_game_name',
        '_cozy_rating_global',
        '_cozy_game_playtime',
    );

    foreach ( $checks as $key ) {
        if ( get_post_meta( $post_id, $key, true ) ) {
            return true;
        }
    }

    return false;
}

/**
 * Injecte la fiche jeu et le verdict dans le contenu de l'article
 */
function cozy_inject_article_game_card( $content ) {
    if ( ! is_singular( 'post' ) || ! in_the_loop() || ! is_main_query() ) {
        return $content;
    }

    $post_id = get_the_ID();

    if ( ! cozy_article_has_game_data( $post_id ) ) {
        return $content;
    }

    $game_card  = cozy_render_game_card( $post_id );
    $verdict    = cozy_render_verdict_card( $post_id );

    return $game_card . $content . $verdict;
}
add_filter( 'the_content', 'cozy_inject_article_game_card', 15 );


/**
 * G√©n√®re le HTML de la fiche jeu
 *
 * @param int $post_id
 * @return string HTML
 */
function cozy_render_game_card( $post_id ) {
    $game_name   = get_post_meta( $post_id, '_cozy_game_name', true );
    $platforms   = json_decode( get_post_meta( $post_id, '_cozy_game_platforms', true ) ?: '[]', true );
    $players     = get_post_meta( $post_id, '_cozy_game_players', true );
    $playtime    = get_post_meta( $post_id, '_cozy_game_playtime', true );
    $developer   = get_post_meta( $post_id, '_cozy_game_developer', true );
    $publisher   = get_post_meta( $post_id, '_cozy_game_publisher', true );
    $global_rating = (int) get_post_meta( $post_id, '_cozy_rating_global', true );
    $ratings_json  = get_post_meta( $post_id, '_cozy_ratings', true );
    $ratings       = json_decode( $ratings_json ?: '{}', true );

    // Ne rien afficher si aucune donn√©e de fiche
    if ( empty( $game_name ) && empty( $platforms ) && empty( $playtime ) ) {
        return '';
    }

    // Type d'article
    $article_type = '';
    $type_data    = null;
    $terms = wp_get_post_terms( $post_id, 'cozy_article_type', array( 'fields' => 'slugs' ) );
    if ( ! is_wp_error( $terms ) && ! empty( $terms ) ) {
        $article_type = $terms[0];
        $all_types = cozy_get_article_types();
        $type_data = isset( $all_types[ $article_type ] ) ? $all_types[ $article_type ] : null;
    }

    $all_platforms = cozy_get_platforms();
    $criteria      = cozy_get_rating_criteria();

    ob_start();
    ?>
    <div class="cozy-game-card">
        <?php // Badge type d'article ?>
        <?php if ( $type_data ) : ?>
            <div class="cozy-game-card__type-badge" style="background: <?php echo esc_attr( $type_data['color'] ); ?>;">
                <?php echo $type_data['icon'] . ' ' . esc_html( $type_data['label'] ); ?>
            </div>
        <?php endif; ?>

        <div class="cozy-game-card__header">
            <?php if ( ! empty( $game_name ) ) : ?>
                <h2 class="cozy-game-card__game-name"><?php echo esc_html( $game_name ); ?></h2>
            <?php endif; ?>

            <?php if ( $global_rating > 0 ) : ?>
                <div class="cozy-game-card__global-rating">
                    <div class="cozy-game-card__stars">
                        <?php for ( $i = 1; $i <= 5; $i++ ) : ?>
                            <span class="cozy-game-card__star <?php echo ( $i <= $global_rating ) ? 'filled' : ''; ?>">‚òÖ</span>
                        <?php endfor; ?>
                    </div>
                    <span class="cozy-game-card__rating-value"><?php echo $global_rating; ?>/5</span>
                </div>
            <?php endif; ?>
        </div>

        <?php // --- Infos du jeu --- ?>
        <div class="cozy-game-card__details">
            <?php if ( ! empty( $platforms ) ) : ?>
                <div class="cozy-game-card__detail">
                    <span class="cozy-game-card__detail-label">Plateformes</span>
                    <div class="cozy-game-card__platforms">
                        <?php foreach ( $platforms as $slug ) :
                            $label = isset( $all_platforms[ $slug ] ) ? $all_platforms[ $slug ] : $slug;
                        ?>
                            <span class="cozy-game-card__platform"><?php echo esc_html( $label ); ?></span>
                        <?php endforeach; ?>
                    </div>
                </div>
            <?php endif; ?>

            <?php if ( ! empty( $players ) ) : ?>
                <div class="cozy-game-card__detail">
                    <span class="cozy-game-card__detail-label">üë• Joueurs</span>
                    <span class="cozy-game-card__detail-value"><?php echo esc_html( $players ); ?></span>
                </div>
            <?php endif; ?>

            <?php if ( ! empty( $playtime ) ) : ?>
                <div class="cozy-game-card__detail">
                    <span class="cozy-game-card__detail-label">‚è±Ô∏è Temps de jeu</span>
                    <span class="cozy-game-card__detail-value"><?php echo esc_html( $playtime ); ?></span>
                </div>
            <?php endif; ?>

            <?php if ( ! empty( $developer ) ) : ?>
                <div class="cozy-game-card__detail">
                    <span class="cozy-game-card__detail-label">üõ†Ô∏è D√©veloppeur</span>
                    <span class="cozy-game-card__detail-value"><?php echo esc_html( $developer ); ?></span>
                </div>
            <?php endif; ?>

            <?php if ( ! empty( $publisher ) ) : ?>
                <div class="cozy-game-card__detail">
                    <span class="cozy-game-card__detail-label">üì¶ √âditeur</span>
                    <span class="cozy-game-card__detail-value"><?php echo esc_html( $publisher ); ?></span>
                </div>
            <?php endif; ?>
        </div>

        <?php // --- Notes d√©taill√©es --- ?>
        <?php if ( ! empty( $ratings ) ) : ?>
            <div class="cozy-game-card__ratings">
                <h3 class="cozy-game-card__ratings-title">üìä Notes d√©taill√©es</h3>
                <div class="cozy-game-card__ratings-grid">
                    <?php foreach ( $ratings as $slug => $value ) :
                        if ( ! isset( $criteria[ $slug ] ) ) continue;
                        $criterion = $criteria[ $slug ];
                        $percent   = ( $value / 5 ) * 100;
                    ?>
                        <div class="cozy-game-card__rating-row">
                            <span class="cozy-game-card__rating-label">
                                <?php echo $criterion['icon'] . ' ' . esc_html( $criterion['label'] ); ?>
                            </span>
                            <div class="cozy-game-card__rating-bar">
                                <div class="cozy-game-card__rating-fill" style="width: <?php echo $percent; ?>%;" data-value="<?php echo $value; ?>"></div>
                            </div>
                            <span class="cozy-game-card__rating-score"><?php echo $value; ?>/5</span>
                        </div>
                    <?php endforeach; ?>
                </div>
            </div>
        <?php endif; ?>
    </div>
    <?php
    return ob_get_clean();
}


/**
 * -----------------------------------------------
 * 6. AFFICHAGE FRONT-END ‚Äî VERDICT (en bas)
 * -----------------------------------------------
 */

/**
 * G√©n√®re le HTML du verdict (affich√© apr√®s le contenu)
 *
 * @param int $post_id
 * @return string HTML
 */
function cozy_render_verdict_card( $post_id ) {
    $verdict   = get_post_meta( $post_id, '_cozy_verdict', true );
    $pros_json = get_post_meta( $post_id, '_cozy_pros', true );
    $cons_json = get_post_meta( $post_id, '_cozy_cons', true );
    $pros      = json_decode( $pros_json ?: '[]', true );
    $cons      = json_decode( $cons_json ?: '[]', true );
    $global_rating = (int) get_post_meta( $post_id, '_cozy_rating_global', true );

    // Ne rien afficher si pas de verdict
    if ( empty( $verdict ) && empty( $pros ) && empty( $cons ) ) {
        return '';
    }

    ob_start();
    ?>
    <div class="cozy-verdict">
        <h3 class="cozy-verdict__title">üìù Notre verdict</h3>

        <?php if ( ! empty( $verdict ) ) : ?>
            <blockquote class="cozy-verdict__text">
                <?php echo esc_html( $verdict ); ?>
            </blockquote>
        <?php endif; ?>

        <?php if ( ! empty( $pros ) || ! empty( $cons ) ) : ?>
            <div class="cozy-verdict__pros-cons">
                <?php if ( ! empty( $pros ) ) : ?>
                    <div class="cozy-verdict__column cozy-verdict__column--pros">
                        <h4>‚úÖ Points forts</h4>
                        <ul>
                            <?php foreach ( $pros as $pro ) : ?>
                                <li><?php echo esc_html( $pro ); ?></li>
                            <?php endforeach; ?>
                        </ul>
                    </div>
                <?php endif; ?>

                <?php if ( ! empty( $cons ) ) : ?>
                    <div class="cozy-verdict__column cozy-verdict__column--cons">
                        <h4>‚ùå Points faibles</h4>
                        <ul>
                            <?php foreach ( $cons as $con ) : ?>
                                <li><?php echo esc_html( $con ); ?></li>
                            <?php endforeach; ?>
                        </ul>
                    </div>
                <?php endif; ?>
            </div>
        <?php endif; ?>

        <?php if ( $global_rating > 0 ) : ?>
            <div class="cozy-verdict__final-score">
                <span class="cozy-verdict__score-label">Note finale</span>
                <div class="cozy-verdict__score-value">
                    <span class="cozy-verdict__score-number"><?php echo $global_rating; ?></span>
                    <span class="cozy-verdict__score-max">/5</span>
                </div>
                <div class="cozy-verdict__score-stars">
                    <?php for ( $i = 1; $i <= 5; $i++ ) : ?>
                        <span class="cozy-verdict__star <?php echo ( $i <= $global_rating ) ? 'filled' : ''; ?>">‚òÖ</span>
                    <?php endfor; ?>
                </div>
            </div>
        <?php endif; ?>
    </div>
    <?php
    return ob_get_clean();
}


/**
 * -----------------------------------------------
 * 7. COLONNES ADMIN PERSONNALIS√âES
 * -----------------------------------------------
 */

/**
 * Ajoute des colonnes dans la liste des articles (admin)
 */
function cozy_article_admin_columns( $columns ) {
    $new_columns = array();

    foreach ( $columns as $key => $label ) {
        $new_columns[ $key ] = $label;

        // Ins√©rer apr√®s le titre
        if ( 'title' === $key ) {
            $new_columns['cozy_game']   = 'üéÆ Jeu';
            $new_columns['cozy_rating'] = '‚≠ê Note';
        }
    }

    return $new_columns;
}
add_filter( 'manage_posts_columns', 'cozy_article_admin_columns' );

/**
 * Remplit les colonnes personnalis√©es
 */
function cozy_article_admin_column_content( $column, $post_id ) {
    switch ( $column ) {
        case 'cozy_game':
            $name = get_post_meta( $post_id, '_cozy_game_name', true );
            echo ! empty( $name ) ? esc_html( $name ) : '<span style="color:#999;">‚Äî</span>';
            break;

        case 'cozy_rating':
            $rating = (int) get_post_meta( $post_id, '_cozy_rating_global', true );
            if ( $rating > 0 ) {
                $stars = str_repeat( '‚òÖ', $rating ) . str_repeat( '‚òÜ', 5 - $rating );
                echo '<span style="color:#f59e0b;font-size:1.1em;">' . $stars . '</span>';
            } else {
                echo '<span style="color:#999;">‚Äî</span>';
            }
            break;
    }
}
add_action( 'manage_posts_custom_column', 'cozy_article_admin_column_content', 10, 2 );


/**
 * -----------------------------------------------
 * 8. STYLES ADMIN (META BOXES)
 * -----------------------------------------------
 */
function cozy_article_admin_styles() {
    $screen = get_current_screen();
    if ( ! $screen || 'post' !== $screen->id ) {
        return;
    }

    ?>
    <style>
        /* Meta box container */
        .cozy-meta-box { padding: 8px 0; }
        .cozy-meta-box__hint {
            background: #f0f9ff;
            border-left: 3px solid #3b82f6;
            padding: 10px 14px;
            border-radius: 0 8px 8px 0;
            font-size: 13px;
            color: #1e40af;
            margin: 0 0 16px;
        }
        .cozy-meta-box__table th { width: 160px; vertical-align: top; }
        .cozy-meta-box__table th .description { font-weight: 400; }

        /* Plateformes */
        .cozy-meta-box__platforms {
            display: flex; flex-wrap: wrap; gap: 8px;
        }
        .cozy-meta-box__platform-label {
            display: inline-flex; align-items: center; gap: 4px;
            background: #f8fafc; border: 1px solid #e2e8f0;
            border-radius: 8px; padding: 6px 12px; font-size: 13px;
            cursor: pointer; transition: .15s;
        }
        .cozy-meta-box__platform-label:hover { background: #f1f5f9; }
        .cozy-meta-box__platform-label:has(input:checked) {
            background: #ede9fe; border-color: #a78bfa; color: #5b21b6;
        }

        /* √âtoiles */
        .cozy-meta-box__stars {
            display: flex; align-items: center; gap: 2px;
        }
        .cozy-meta-box__star-label { cursor: pointer; }
        .cozy-meta-box__star-label input { display: none; }
        .cozy-meta-box__star {
            font-size: 28px; color: #d1d5db;
            transition: color .15s, transform .1s;
        }
        .cozy-meta-box__star:hover,
        .cozy-meta-box__star.active { color: #f59e0b; }
        .cozy-meta-box__star-label:hover .cozy-meta-box__star { transform: scale(1.15); }
        .cozy-meta-box__clear-rating {
            margin-left: 10px !important; font-size: 12px !important;
        }

        /* Pros / Cons */
        .cozy-meta-box__pros-cons {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
            margin-top: 16px;
        }
        .cozy-meta-box__column h4 { margin: 0 0 10px; }
        .cozy-meta-box__column--pros h4 { color: #059669; }
        .cozy-meta-box__column--cons h4 { color: #dc2626; }
        .cozy-meta-box__list-item {
            display: flex; gap: 6px; margin-bottom: 6px;
        }
        .cozy-meta-box__list-item input { flex: 1; }
        .cozy-meta-box__remove-item {
            color: #dc2626 !important; min-width: 30px;
        }
        .cozy-meta-box__add-item { margin-top: 6px !important; }
    </style>
    <?php
}
add_action( 'admin_head', 'cozy_article_admin_styles' );


/**
 * -----------------------------------------------
 * 9. SCRIPT ADMIN (INTERACTIONS META BOXES)
 * -----------------------------------------------
 */
function cozy_article_admin_scripts() {
    $screen = get_current_screen();
    if ( ! $screen || 'post' !== $screen->id ) {
        return;
    }

    ?>
    <script>
    document.addEventListener('DOMContentLoaded', function() {

        // --- Interactivit√© des √©toiles ---
        document.querySelectorAll('.cozy-meta-box__stars').forEach(function(group) {
            var stars = group.querySelectorAll('.cozy-meta-box__star');
            var radios = group.querySelectorAll('input[type="radio"]');

            // Hover preview
            stars.forEach(function(star, index) {
                star.addEventListener('mouseenter', function() {
                    stars.forEach(function(s, i) {
                        s.classList.toggle('active', i <= index);
                    });
                });
            });

            group.addEventListener('mouseleave', function() {
                var checked = group.querySelector('input[type="radio"]:checked');
                var checkedIndex = checked ? Array.from(radios).indexOf(checked) : -1;
                stars.forEach(function(s, i) {
                    s.classList.toggle('active', i <= checkedIndex);
                });
            });

            // Click
            radios.forEach(function(radio, index) {
                radio.addEventListener('change', function() {
                    stars.forEach(function(s, i) {
                        s.classList.toggle('active', i <= index);
                    });
                });
            });
        });

        // --- Bouton effacer note ---
        document.querySelectorAll('.cozy-meta-box__clear-rating').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var group = btn.closest('.cozy-meta-box__stars');
                group.querySelectorAll('input[type="radio"]').forEach(function(r) {
                    r.checked = false;
                });
                group.querySelectorAll('.cozy-meta-box__star').forEach(function(s) {
                    s.classList.remove('active');
                });
            });
        });

        // --- Ajouter un item (pros/cons) ---
        document.querySelectorAll('.cozy-meta-box__add-item').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var listId = btn.getAttribute('data-list');
                var name   = btn.getAttribute('data-name');
                var list   = document.getElementById(listId);

                var div = document.createElement('div');
                div.className = 'cozy-meta-box__list-item';
                div.innerHTML =
                    '<input type="text" name="' + name + '" class="regular-text" placeholder="Nouveau point‚Ä¶">' +
                    '<button type="button" class="button cozy-meta-box__remove-item" title="Supprimer">‚úï</button>';
                list.appendChild(div);
            });
        });

        // --- Supprimer un item (pros/cons) ---
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('cozy-meta-box__remove-item')) {
                e.target.closest('.cozy-meta-box__list-item').remove();
            }
        });

    });
    </script>
    <?php
}
add_action( 'admin_footer', 'cozy_article_admin_scripts' );


/**
 * -----------------------------------------------
 * 10. ENQUEUE DES ASSETS FRONT-END
 * -----------------------------------------------
 */
function cozy_articles_enqueue_assets() {
    wp_enqueue_style(
        'cozy-articles',
        get_stylesheet_directory_uri() . '/assets/css/cozy-articles.css',
        array(),
        '1.7.0'
    );
}
add_action( 'wp_enqueue_scripts', 'cozy_articles_enqueue_assets' );
